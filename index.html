<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PBQ Runner — Lesson 8 (Scenario + Tasks)</title>
  <style>
    :root {
      --bg: #f4f6fa;
      --card: #ffffff;
      --ink: #1b1f2f;
      --ink-dim: #5c6373;
      --accent: #2463eb;
      --ok: #2ba84a;
      --warn: #e0a106;
      --err: #e63946;
      --line: #dfe3eb;
      --muted-bg: #fafbff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font: 16px/1.5 "Segoe UI", Roboto, system-ui, sans-serif;
    }

    header {
      padding: 20px 16px;
      border-bottom: 1px solid #d7dce6;
      background: #ffffff;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    h1 {
      margin: 0.2rem 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    main {
      max-width: 900px;
      margin: 32px auto;
      padding: 0 16px;
    }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      margin: 0.75rem 0;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      appearance: none;
      border: 1px solid #c2c8d6;
      background: #f8f9fb;
      color: var(--ink);
      padding: 0.55rem 0.9rem;
      height: 40px;
      min-width: 130px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      line-height: 1.2;
      text-align: center;
      transition: all 0.15s ease-in-out;
      text-decoration: none;
    }
    .btn:hover { background: #eaf0ff; border-color: var(--accent); }
    .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn.primary:hover { background: #1f56c4; }

    .pill {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      background: #f0f4ff;
      border: 1px solid #c8d4fa;
      color: var(--accent);
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.2px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .pill2 {
      display: inline-block;
      padding: 0.25rem 0.8rem;
      border-radius: 10px;
      background: #f0f4ff;
      border: 1px solid #c8d4fa;
      color: var(--accent);
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.2px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px;
      margin: 20px 0;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
    }

    .title { font-weight: 700; }
    .muted { color: var(--ink-dim); }

    .scenario-wrap {
      display: grid;
      gap: 8px;
    }
    .scenario-label {
      display: inline-block;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      background: #e9f9ef;
      border: 1px solid #c6ebd3;
      color: #116a3d;
      font-size: 0.85rem;
      font-weight: 800;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      width: max-content;
    }
    .scenario {
      white-space: pre-wrap;
      color: #2b2f3c;
    }

    .task { margin-top: 8px; }
    .task h3 {
      margin: 0.2rem 0 0.6rem;
      font-size: 1.05rem;
      color: var(--accent);
    }

    .options { display: grid; gap: 0.4rem; }

    .ordering { display: grid; gap: 0.5rem; }

    .draggable {
      padding: 0.6rem 0.7rem;
      border: 1px dashed #b5bfd6;
      border-radius: 10px;
      background: #fafbfe;
      cursor: grab;
      transition: background 0.15s;
    }
    .draggable:hover { background: #eef3ff; }
    .draggable.dragging { opacity: 0.8; border-style: solid; }
    .draggable::before {
      content: '⋮⋮';
      color: #9aa8c0;
      margin-right: 8px;
      font-size: 14px;
    }

    .result { margin-top: 10px; font-weight: 600; }
    .correct { color: var(--ok); }
    .incorrect { color: var(--err); }

    .answer {
      background: #f7f9ff;
      border: 1px solid #d3daf4;
      color: #2b2f3c;
      padding: 0.6rem;
      border-radius: 10px;
      margin-top: 0.6rem;
    }

    .feedback {
      margin-top: 6px;
      padding: 0.55rem 0.7rem;
      border: 1px solid #f1c9cf;
      background: #fff5f6;
      color: #7a1e27;
      border-radius: 8px;
      font-size: 0.95rem;
    }

    footer {
      max-width: 900px;
      margin: 40px auto 80px;
      padding: 0 16px;
      color: #707789;
      font-size: 0.9rem;
      text-align: center;
    }

    select {
      background: #ffffff;
      color: var(--ink);
      border: 1px solid #cbd2e0;
      padding: 0.35rem 0.5rem;
      border-radius: 8px;
      margin: 0 0.35rem;
    }
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(36, 99, 235, 0.2);
    }

    /* ====== PBQ 1 (Kanban) ====== */
    .lanes { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .lane {
      min-height: 160px; padding: 10px; border:1px dashed #c9d1e3; border-radius: 12px; background: var(--muted-bg);
    }
    .lane h4 { margin:.2rem 0 .5rem; color:#2b4aa6; }
    .finding {
      background:#fff; border:1px solid var(--line); border-radius: 12px; padding:.55rem .65rem; margin:.45rem 0;
      cursor:grab; box-shadow: 0 4px 10px rgba(0,0,0,.04);
    }
    .finding.dragging { opacity:.85; border-style: solid; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; margin:.15rem 0 .25rem }
    .chip { background:#eef2ff; border:1px solid #cdd7ff; color:#1f44b4; padding:.1rem .45rem; border-radius:999px; font-size:.75rem }
    .meta { color: var(--ink-dim); font-size:.9rem }

    /* ====== PBQ 4 (Matrix) ====== */
    table { width:100%; border-collapse:separate; border-spacing:0 }
    th, td { padding:10px; border-bottom:1px solid var(--line); text-align:left }
    th { background:#f6f8ff; }

    @media (max-width: 640px) {
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-left, .toolbar-right { justify-content: center; }
      .btn { flex: 1 1 auto; min-width: unset; }
      .lanes { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="pill">Lesson 8 • Vulnerability Management</div>

    <div class="toolbar">
      <div class="toolbar-left">
        <a class="btn" href="lesson8_practice_questions.html" target="_blank">Practice Questions</a>
        <a class="btn" href="audio_review.html" target="_blank">Audio Review</a>
      </div>

      <div class="toolbar-right">
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn primary" id="btnCheck">Check Answers</button>
      </div>
    </div>
  </header>
  <main>
    <section class="card">
      <div class="title" id="pbq_title">Weekly Risk Review @ KonaTech</div>
      <div class="muted" id="lesson">Lesson 8 – Explain Vulnerability Management</div>
      <div class="scenario-wrap">
        <div class="scenario-label">Scenario</div>
        <p class="scenario" id="scenario">
You’ve inherited a mixed environment (Windows/Linux servers, laptops, a few EOL systems, public cloud storage, and several SaaS apps).
Your continuous scans and a fresh SBOM import flagged multiple issues. Leadership cares most about data exposure and keeping customer-facing apps up.
Your job today: triage the findings, and pick sensible scan approaches/cadences for key assets. Verification (re-scan) is required for closure.
        </p>
      </div>
      <div class="pill2" id="meta">Intermediate • ~10 min</div>
    </section>

    <section id="tasks"></section>

    <!-- =================== PBQ 1: Vulnerability Triage (Kanban) =================== -->
    <section class="card" id="pbq1">
      <div class="scenario-label" style="background:#e9f3ff;border-color:#cfe0ff;color:#1b4cb8">PBQ 1</div>
      <h2 style="margin:8px 0 2px">Drag each finding into the correct lane</h2>
      <p class="muted" style="margin:0 0 8px">
        Lanes: <b>Fix Now</b> (same day), <b>Fix Next</b> (within sprint), <b>Schedule</b> (next standard window). Consider exploitability, exposure, and business impact.
      </p>
      <div class="lanes" style="margin-top:8px">
        <div class="lane" data-lane="NOW"><h4>Fix Now</h4></div>
        <div class="lane" data-lane="NEXT"><h4>Fix Next</h4></div>
        <div class="lane" data-lane="LATER"><h4>Schedule</h4></div>
      </div>
      <div id="pool" style="margin-top:10px"></div>
      <div class="result" id="pbq1_result"></div>
      <div class="feedback" id="pbq1_fb" hidden></div>
    </section>

    <!-- =================== PBQ 4: Scan Strategy Matrix =================== -->
    <section class="card" id="pbq4">
      <div class="scenario-label" style="background:#e9f3ff;border-color:#cfe0ff;color:#1b4cb8">PBQ 2</div>
      <h2 style="margin:8px 0 2px">Design the scan strategy</h2>
      <p class="muted" style="margin:0 0 8px">
        Choose <b>scan type</b> and <b>cadence</b> per asset. Balance depth and practicality.
      </p>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Asset</th><th>Context</th><th>Scan Type</th><th>Cadence</th>
            </tr>
          </thead>
          <tbody id="scan_tbody"></tbody>
        </table>
      </div>
      <div class="result" id="pbq4_result"></div>
      <div class="feedback" id="pbq4_fb" hidden></div>
    </section>
  </main>

  <footer>
    Built for quick study-aid demos (Lesson 8). Triage + strategy = identify → analyze → treat → verify.
  </footer>

  <!-- Embedded PBQ JSON (kept minimal; renderer will ignore since we’re using custom PBQs) -->
  <script type="application/json" id="pbq-data">{
    "pbq_title": "Weekly Risk Review @ KonaTech",
    "lesson": "Lesson 8 – Explain Vulnerability Management",
    "scenario": "See above",
    "tasks": [],
    "concepts_tested": ["Prioritization","Scan strategy"],
    "difficulty": "Intermediate",
    "estimated_time_minutes": 10
  }</script>

  <script>
/* tiny qs helpers */
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

let PBQ = null;
let userAnswers = new Map();

function loadPBQFromScriptTag(){
  try{
    const tag = document.getElementById('pbq-data');
    PBQ = JSON.parse(tag.textContent);
    renderAll();
  }catch(err){
    console.error('Embedded PBQ JSON parse failed:', err);
    // It's ok if this fails; custom PBQs render regardless.
  }
}

/* ---------- Renderer for legacy task types (none used now, but kept for compatibility) ---------- */
function renderAll(){
  if(!PBQ) return;
  $('#pbq_title').textContent = PBQ.pbq_title || '—';
  $('#lesson').textContent = PBQ.lesson || '—';
  $('#scenario').textContent = PBQ.scenario || '—';
  $('#meta').textContent = `${PBQ.difficulty || '—'} • ~${PBQ.estimated_time_minutes || '—'} min`;

  const tasksWrap = $('#tasks');
  tasksWrap.innerHTML = '';

  (PBQ.tasks || []).forEach(task => {
    if (task.type === 'multiple_choice') return; // MC not used here

    const card = document.createElement('section');
    card.className = 'card task';
    card.dataset.taskId = task.task_id;

    const typeLabel = task.type.replace('_',' ');
    const title = document.createElement('h3');
    title.textContent = `Task ${task.task_id} — Reference the Scenario: ${typeLabel}`;
    card.appendChild(title);

    const prompt = document.createElement('p');
    prompt.textContent = `Reference the Scenario above: ${task.prompt}`;
    card.appendChild(prompt);

    if(task.type === 'ordering'){
      const list = document.createElement('div'); list.className = 'ordering';
      task.steps.forEach((s, idx)=>{
        const div = document.createElement('div');
        div.className = 'draggable';
        div.draggable = true;
        div.dataset.index = idx+1;
        div.textContent = s;
        list.appendChild(div);
      });
      enableDrag(list, task.task_id);
      card.appendChild(list);

      const result = document.createElement('div'); result.className = 'result'; card.appendChild(result);

      const details = document.createElement('details');
      const sum = document.createElement('summary'); sum.textContent = 'Rationale';
      const ans = document.createElement('div'); ans.className = 'answer';
      ans.textContent = task.correct_order.map(i=>task.steps[i-1]).join(' \u2192 ');
      details.appendChild(sum); details.appendChild(ans);
      details.hidden = true;
      card.appendChild(details);
    }

    if(task.type === 'fill_in_dropdown'){
      const p = document.createElement('p');
      const parts = (task.sentence||'').split('______');
      parts.forEach((text, idx)=>{
        p.append(text);
        if(idx < (task.blanks||[]).length){
          const sel = document.createElement('select');
          sel.dataset.blankId = task.blanks[idx].blank_id;
          const ph = document.createElement('option'); ph.value=''; ph.textContent='— select —'; ph.disabled=true; ph.selected=true; sel.appendChild(ph);
          task.blanks[idx].choices.forEach(choice=>{
            const opt = document.createElement('option');
            opt.value = choice; opt.textContent = choice;
            sel.appendChild(opt);
          });
          sel.addEventListener('change', ()=>{
            const current = userAnswers.get(task.task_id) || {};
            current[task.blanks[idx].blank_id] = sel.value;
            userAnswers.set(task.task_id, current);
          });
          p.append(sel);
        }
      });
      card.appendChild(p);

      const result = document.createElement('div'); result.className = 'result'; card.appendChild(result);

      const details = document.createElement('details');
      const sum = document.createElement('summary'); sum.textContent = 'Rationale';
      const ans = document.createElement('div'); ans.className = 'answer'; ans.textContent = task.rationale || '';
      details.appendChild(sum); details.appendChild(ans);
      details.hidden = true;
      card.appendChild(details);
    }

    tasksWrap.appendChild(card);
  });
}

/* ---------- Drag + order helpers (legacy) ---------- */
function enableDrag(container, taskId){
  let dragEl = null;
  container.addEventListener('dragstart', e=>{
    if(e.target.classList.contains('draggable')){
      dragEl = e.target;
      e.dataTransfer.effectAllowed='move';
      e.target.classList.add('dragging');
    }
  });
  container.addEventListener('dragend', ()=>{
    if(dragEl){ dragEl.classList.remove('dragging'); dragEl = null; }
    const order = $$('.draggable', container).map(d=>Number(d.dataset.index));
    userAnswers.set(taskId, {order});
  });
  container.addEventListener('dragover', e=>{
    e.preventDefault();
    const after = getDragAfterElement(container, e.clientY);
    const dragging = $('.draggable.dragging', container);
    if(!dragging) return;
    if(after == null){ container.appendChild(dragging); }
    else { container.insertBefore(dragging, after); }
  });
}
function getDragAfterElement(container, y){
  const els = $$('.draggable:not(.dragging)', container);
  let closest = {offset: Number.NEGATIVE_INFINITY, element: null};
  els.forEach(el=>{
    const box = el.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if(offset < 0 && offset > closest.offset){ closest = {offset, element: el}; }
  });
  return closest.element;
}

/* ---------- Global grading/feedback shell (legacy tasks) ---------- */
function checkAnswersLegacy(){
  (PBQ?.tasks || []).forEach(task=>{
    if (task.type === 'multiple_choice') return;

    const card = document.querySelector(`.task[data-task-id="${task.task_id}"]`);
    const result = card?.querySelector('.result');
    const details = card?.querySelector('details');
    if(result) result.textContent = '';
    if(details) details.hidden = true;

    if(task.type === 'ordering'){
      let order = userAnswers.get(task.task_id)?.order;
      if(!order){
        const list = card.querySelector('.ordering');
        order = Array.from(list.querySelectorAll('.draggable')).map(d=>Number(d.dataset.index));
      }
      const ok = JSON.stringify(order) === JSON.stringify(task.correct_order);
      result.textContent = ok ? 'Correct order ✓' : 'Incorrect order ✗';
      result.className = 'result ' + (ok ? 'correct' : 'incorrect');
      if(!ok && details) details.hidden = false;
      return;
    }

    if(task.type === 'fill_in_dropdown'){
      let answers = userAnswers.get(task.task_id) || {};
      const selects = card.querySelectorAll('select[data-blank-id]');
      selects.forEach(s => answers[s.dataset.blankId] = s.value);
      let ok = (task.blanks||[]).every(b => answers[b.blank_id] === b.answer);
      result.textContent = ok ? 'Correct ✓' : 'Incorrect ✗';
      result.className = 'result ' + (ok ? 'correct' : 'incorrect');
      if(!ok && details) details.hidden = false;
      return;
    }
  });
}

/* =================== PBQ 1: Vulnerability Triage (Kanban) =================== */
const FINDINGS = [
  { id:'F1', title:'Public cloud bucket allows listing + read of PII', tags:['Cloud','Exposure'], meta:'Impact: High • Exploit: Live (misconfig)', expect:'NOW',
    why:'Public data exposure can leak immediately; block public and fix policy now.'},
  { id:'F2', title:'DB-01: Critical RCE with exploit in the wild (CVSS 9.8)', tags:['Server','Critical'], meta:'Impact: High • Exploit: Yes', expect:'NOW',
    why:'High-value system with known exploit → emergency patch or compensating control.'},
  { id:'F3', title:'HR-LAP12: High severity vuln (8.1), PoC only', tags:['Endpoint'], meta:'Impact: Low • Exploit: PoC', expect:'NEXT',
    why:'Lower business impact + PoC only → fix in sprint after urgent items.'},
  { id:'F4', title:'WEB-02: Deprecated 3DES still enabled', tags:['Crypto','Config'], meta:'Impact: Medium • Exploit: Weak cipher', expect:'NEXT',
    why:'Replace deprecated cipher; typically not same-day unless mandated.'},
  { id:'F5', title:'Legacy backup server on EOL OS (segmented)', tags:['EOL','Legacy'], meta:'Impact: Medium • Segmented', expect:'LATER',
    why:'Plan upgrade/migration in standard window if properly isolated.'}
];

let KANBAN_STATE = { NOW:[], NEXT:[], LATER:[], POOL:[] };

function makeFindingCard(f){
  const el = document.createElement('div');
  el.className='finding'; el.draggable=true; el.dataset.id=f.id;
  el.innerHTML = `
    <div class="chips">${f.tags.map(t=>`<span class="chip">${t}</span>`).join(' ')}</div>
    <div style="font-weight:700">${f.title}</div>
    <div class="meta">${f.meta}</div>`;
  el.addEventListener('dragstart', e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain', f.id); });
  el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
  return el;
}

function renderKanban(){
  const lanes = { NOW:$('[data-lane="NOW"]'), NEXT:$('[data-lane="NEXT"]'), LATER:$('[data-lane="LATER"]') };
  Object.values(lanes).forEach(l=> l.querySelectorAll('.finding').forEach(el=>el.remove()));
  $('#pool').innerHTML = '';
  for(const lane of ['NOW','NEXT','LATER']){
    if(!KANBAN_STATE[lane].length){
      const ghost = document.createElement('div');
      ghost.className='muted'; ghost.style.fontStyle='italic'; ghost.textContent='Drag here';
      lanes[lane].appendChild(ghost);
    }
    KANBAN_STATE[lane].forEach(f => lanes[lane].appendChild(makeFindingCard(f)));
  }
  KANBAN_STATE.POOL.forEach(f => $('#pool').appendChild(makeFindingCard(f)));
}

function setupDnd(){
  const zones = [ $('[data-lane="NOW"]'), $('[data-lane="NEXT"]'), $('[data-lane="LATER"]'), $('#pool') ];
  zones.forEach(zone=>{
    zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.style.outline='1px dashed #7aa0ff'; });
    zone.addEventListener('dragleave', ()=> zone.style.outline='none');
    zone.addEventListener('drop', e=>{
      e.preventDefault(); zone.style.outline='none';
      const id = e.dataTransfer.getData('text/plain');
      moveTo(zone.id ? 'POOL' : zone.dataset.lane, id);
      renderKanban();
    });
  });
}
function moveTo(target, id){
  for(const lane of ['NOW','NEXT','LATER','POOL']){
    const i = KANBAN_STATE[lane].findIndex(x=>x.id===id);
    if(i>=0){ KANBAN_STATE[lane].splice(i,1); break; }
  }
  KANBAN_STATE[target].push(FINDINGS.find(x=>x.id===id));
}

function initKanban(){
  KANBAN_STATE = { NOW:[], NEXT:[], LATER:[], POOL: [...FINDINGS].sort(()=>Math.random()-0.5) };
  renderKanban(); setupDnd();
}
function gradeKanban(){
  let correct=0, total=FINDINGS.length; const fb=[];
  for(const lane of ['NOW','NEXT','LATER']){
    for(const f of KANBAN_STATE[lane]){
      if(lane===f.expect) correct++; else fb.push(`• ${f.title}: should be in ${f.expect}. ${f.why}`);
    }
  }
  $('#pbq1_result').textContent = `${correct}/${total} placed correctly`;
  $('#pbq1_result').className = 'result ' + (correct===total ? 'correct' : 'incorrect');
  const el = $('#pbq1_fb'); if(fb.length){ el.hidden=false; el.innerHTML=fb.join('<br>'); } else { el.hidden=true; el.textContent=''; }
}

/* =================== PBQ 4: Scan Strategy Matrix =================== */
const ASSETS = [
  { name:'DMZ Web Server', ctx:'Customer-facing, change-prone', expectType:'Credentialed', expectCadence:'Weekly',
    why:'Credentialed checks confirm patches/configs; internet exposure → frequent.'},
  { name:'Finance DB', ctx:'High impact, restricted window', expectType:'Credentialed', expectCadence:'Weekly',
    why:'Critical data; depth matters to detect misconfig/missing patches.'},
  { name:'Partner API Gateway', ctx:'Internet-accessible, rate-limited', expectType:'Non-credentialed', expectCadence:'Daily',
    why:'Perimeter view to catch exposed vulns; lightweight but frequent scans.'},
  { name:'EOL Backup Host (segmented)', ctx:'Legacy, isolated segment', expectType:'Credentialed', expectCadence:'Bi-weekly',
    why:'Deeper inspection for compensating controls; slightly lower cadence if isolated.'}
];
const TYPES = ['Credentialed','Non-credentialed'];
const CAD   = ['Daily','Weekly','Bi-weekly','Monthly'];

function renderScanMatrix(){
  const tb = $('#scan_tbody'); tb.innerHTML='';
  ASSETS.forEach((a,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${a.name}</b></td>
      <td class="muted">${a.ctx}</td>
      <td>
        <select data-i="${i}" data-k="t">
          <option value="" selected disabled>— select —</option>
          ${TYPES.map(v=>`<option value="${v}">${v}</option>`).join('')}
        </select>
      </td>
      <td>
        <select data-i="${i}" data-k="c">
          <option value="" selected disabled>— select —</option>
          ${CAD.map(v=>`<option value="${v}">${v}</option>`).join('')}
        </select>
      </td>`;
    tb.appendChild(tr);
  });
}
function gradeScanMatrix(){
  let correct=0, total=ASSETS.length*2; const fb=[];
  $$('#scan_tbody select').forEach(sel=>{
    const i = Number(sel.dataset.i), k = sel.dataset.k, row = ASSETS[i], v = sel.value;
    if(!v) return;
    if(k==='t'){ if(v===row.expectType) correct++; else fb.push(`• ${row.name}: use ${row.expectType}. ${row.why}`); }
    else { if(v===row.expectCadence) correct++; else fb.push(`• ${row.name}: cadence ${row.expectCadence}. ${row.why}`); }
  });
  $('#pbq4_result').textContent = `${correct}/${total} selections correct`;
  $('#pbq4_result').className = 'result ' + (correct===total ? 'correct' : 'incorrect');
  const el = $('#pbq4_fb'); if(fb.length){ el.hidden=false; el.innerHTML=fb.join('<br>'); } else { el.hidden=true; el.textContent=''; }
}

/* =================== Global Check/Reset =================== */
function checkAll(){
  checkAnswersLegacy();     // (no-ops if no legacy tasks)
  gradeKanban();
  gradeScanMatrix();
}
function resetAll(){
  userAnswers.clear();
  renderAll();
  initKanban();
  renderScanMatrix();
  // clear results
  ['pbq1_result','pbq4_result'].forEach(id=>{ const n = document.getElementById(id); if(n) n.textContent=''; });
  ['pbq1_fb','pbq4_fb'].forEach(id=>{ const n = document.getElementById(id); if(n){ n.hidden=true; n.textContent=''; } });
}

window.addEventListener('DOMContentLoaded', ()=>{
  loadPBQFromScriptTag();
  initKanban();
  renderScanMatrix();
  document.getElementById('btnCheck')?.addEventListener('click', checkAll);
  document.getElementById('btnReset')?.addEventListener('click', resetAll);
});
  </script>
</body>
</html>
